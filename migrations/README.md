# Database Migrations

–¶–µ–π –ø—Ä–æ–µ–∫—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î [golang-migrate](https://github.com/golang-migrate/migrate) –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å—Ö–µ–º–æ—é –±–∞–∑–∏ –¥–∞–Ω–∏—Ö PostgreSQL.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º—ñ–≥—Ä–∞—Ü—ñ–π

```
migrations/
‚îú‚îÄ‚îÄ 001_create_users_table.up.sql       # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
‚îú‚îÄ‚îÄ 001_create_users_table.down.sql     # –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
‚îú‚îÄ‚îÄ 002_create_listings_table.up.sql    # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –æ–≥–æ–ª–æ—à–µ–Ω—å
‚îú‚îÄ‚îÄ 002_create_listings_table.down.sql  # –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –æ–≥–æ–ª–æ—à–µ–Ω—å
‚îú‚îÄ‚îÄ 003_create_events_table.up.sql      # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –ø–æ–¥—ñ–π
‚îú‚îÄ‚îÄ 003_create_events_table.down.sql    # –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –ø–æ–¥—ñ–π
‚îî‚îÄ‚îÄ README.md                           # –¶–µ–π —Ñ–∞–π–ª
```

## üöÄ –ö–æ–º–∞–Ω–¥–∏

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —á–µ—Ä–µ–∑ Makefile
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ –º—ñ–≥—Ä–∞—Ü—ñ—ó (up)
make migrate-up

# –í—ñ–¥–∫–æ—Ç–∏—Ç–∏ –≤—Å—ñ –º—ñ–≥—Ä–∞—Ü—ñ—ó (down)
make migrate-down

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω—É –≤–µ—Ä—Å—ñ—é
make migrate-version

# –°–∫–∏–Ω—É—Ç–∏ –±–∞–∑—É –¥–∞–Ω–∏—Ö (–Ω–µ–±–µ–∑–ø–µ—á–Ω–æ!)
make db-reset
```

### –ü—Ä—è–º—ñ –∫–æ–º–∞–Ω–¥–∏
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—ó
go run ./cmd/migrate -up

# –í—ñ–¥–∫–æ—Ç–∏—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—ó
go run ./cmd/migrate -down

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤–µ—Ä—Å—ñ—é
go run ./cmd/migrate -version
```

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

–ú—ñ–≥—Ä–∞—Ü—ñ—ó **–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è** –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É API —Å–µ—Ä–≤–µ—Ä–∞. –¶–µ –æ–∑–Ω–∞—á–∞—î:

1. –ü—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `api` –º—ñ–≥—Ä–∞—Ü—ñ—ó –∑–∞–ø—É—Å–∫–∞—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
2. –Ø–∫—â–æ –º—ñ–≥—Ä–∞—Ü—ñ—ó –≤–∂–µ –≤–∏–∫–æ–Ω–∞–Ω—ñ, –≤–æ–Ω–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—å—Å—è
3. –ü—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ –º—ñ–≥—Ä–∞—Ü—ñ—ó —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è

## üìù –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –º—ñ–≥—Ä–∞—Ü—ñ–π

### 1. –ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤
–§–æ—Ä–º–∞—Ç: `{version}_{description}.{up|down}.sql`

–ü—Ä–∏–∫–ª–∞–¥:
```
004_add_user_avatar.up.sql
004_add_user_avatar.down.sql
```

### 2. –ü—Ä–∏–∫–ª–∞–¥ UP –º—ñ–≥—Ä–∞—Ü—ñ—ó
```sql
-- 004_add_user_avatar.up.sql
ALTER TABLE users ADD COLUMN avatar_url VARCHAR(255);
CREATE INDEX idx_users_avatar ON users(avatar_url);
```

### 3. –ü—Ä–∏–∫–ª–∞–¥ DOWN –º—ñ–≥—Ä–∞—Ü—ñ—ó
```sql
-- 004_add_user_avatar.down.sql
DROP INDEX IF EXISTS idx_users_avatar;
ALTER TABLE users DROP COLUMN IF EXISTS avatar_url;
```

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤—ñ –ø—Ä–∞–≤–∏–ª–∞

### DO ‚úÖ
- –ó–∞–≤–∂–¥–∏ —Å—Ç–≤–æ—Ä—é–π—Ç–µ —è–∫ UP, —Ç–∞–∫ —ñ DOWN –º—ñ–≥—Ä–∞—Ü—ñ—ó
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `IF EXISTS` / `IF NOT EXISTS` –¥–µ –º–æ–∂–ª–∏–≤–æ
- –¢–µ—Å—Ç—É–π—Ç–µ –º—ñ–≥—Ä–∞—Ü—ñ—ó –Ω–∞ –∫–æ–ø—ñ—ó production –¥–∞–Ω–∏—Ö
- –†–æ–±—ñ—Ç—å backup –ø–µ—Ä–µ–¥ –≤–∞–∂–ª–∏–≤–∏–º–∏ –∑–º—ñ–Ω–∞–º–∏
- –î–æ—Ç—Ä–∏–º—É–π—Ç–µ—Å—å –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—ó –Ω—É–º–µ—Ä–∞—Ü—ñ—ó

### DON'T ‚ùå
- –ù–µ —Ä–µ–¥–∞–≥—É–π—Ç–µ —ñ—Å–Ω—É—é—á—ñ –º—ñ–≥—Ä–∞—Ü—ñ—ó –ø—ñ—Å–ª—è —ó—Ö –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è
- –ù–µ –≤–∏–¥–∞–ª—è–π—Ç–µ –º—ñ–≥—Ä–∞—Ü—ñ—ó, —è–∫—ñ –≤–∂–µ –±—É–ª–∏ –≤–∏–∫–æ–Ω–∞–Ω—ñ
- –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ DDL –∫–æ–º–∞–Ω–¥–∏, —è–∫—ñ –Ω–µ –º–æ–∂–Ω–∞ –≤—ñ–¥–∫–æ—Ç–∏—Ç–∏
- –ù–µ –¥–æ–¥–∞–≤–∞–π—Ç–µ NOT NULL –∫–æ–ª–æ–Ω–∫–∏ –±–µ–∑ DEFAULT –∑–Ω–∞—á–µ–Ω—å

## üõ†Ô∏è Troubleshooting

### –ü–æ–º–∏–ª–∫–∞ "dirty database"
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞–Ω
make migrate-version

# –Ø–∫—â–æ –±–∞–∑–∞ "dirty", –º–æ–∂–Ω–∞ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏:
# 1. –í–∏–ø—Ä–∞–≤–∏—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É –≤—Ä—É—á–Ω—É –≤ –±–∞–∑—ñ
# 2. –ê–±–æ —Å–∫–∏–Ω—É—Ç–∏ –±–∞–∑—É (–≤—Ç—Ä–∞—Ç–∞ –¥–∞–Ω–∏—Ö!)
make db-reset
```

### –ú—ñ–≥—Ä–∞—Ü—ñ—è –∑–∞—Å—Ç—Ä—è–≥–ª–∞
```bash
# –ü–æ–¥–∏–≤–∏—Ç–∏—Å—è –ª–æ–≥–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
make db-logs

# –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ –±–∞–∑–∏ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞–Ω
docker compose exec postgres psql -U pets_user -d pets_search
```

### –í—ñ–¥–∫–∞—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –º—ñ–≥—Ä–∞—Ü—ñ—ó
–î–ª—è –≤—ñ–¥–∫–∞—Ç—É –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç migrate –Ω–∞–ø—Ä—è–º—É:

```bash
# –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ migrate CLI
go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

# –í—ñ–¥–∫–æ—Ç–∏—Ç–∏ –¥–æ –≤–µ—Ä—Å—ñ—ó N
migrate -database "postgres://pets_user:pets_password@localhost:5432/pets_search?sslmode=disable" -path migrations goto N
```

## üìä –ü–æ—Ç–æ—á–Ω–∞ —Å—Ö–µ–º–∞

### –í–µ—Ä—Å—ñ—è 1: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
- –¢–∞–±–ª–∏—Ü—è `users` –∑ –±–∞–∑–æ–≤–∏–º–∏ –ø–æ–ª—è–º–∏
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è email —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É
- –¢—Ä–∏–≥–µ—Ä–∏ –¥–ª—è `updated_at`

### –í–µ—Ä—Å—ñ—è 2: –û–≥–æ–ª–æ—à–µ–Ω–Ω—è
- –¢–∞–±–ª–∏—Ü—è `listings` –∑ –∑–æ–≤–Ω—ñ—à–Ω—ñ–º –∫–ª—é—á–µ–º –¥–æ `users`
- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –º–∞—Å–∏–≤—ñ–≤ –∑–æ–±—Ä–∞–∂–µ–Ω—å (PostgreSQL arrays)
- Check constraints –¥–ª—è enum –∑–Ω–∞—á–µ–Ω—å

### –í–µ—Ä—Å—ñ—è 3: –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞
- –¢–∞–±–ª–∏—Ü—è `events` –¥–ª—è –∑–±–æ—Ä—É –º–µ—Ç—Ä–∏–∫
- JSONB –ø–æ–ª–µ –¥–ª—è –≥–Ω—É—á–∫–∏—Ö –¥–∞–Ω–∏—Ö
- –Ü–Ω–¥–µ–∫—Å–∏ –¥–ª—è —à–≤–∏–¥–∫–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
